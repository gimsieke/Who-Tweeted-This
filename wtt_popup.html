<!DOCTYPE html>
<html>
  <head>
    <title>Who Tweeted This?</title>
    <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    <style>
@media screen and (min-device-width: 640px) {
  div#tweets {
    min-width: 500px;
  }
}

body {
  font-family: sans-serif;
  font-size: 12pt;
}

h1 {
  font-size: 120%;
  margin:0.4em 1.3em 0 1.3em;
  padding-bottom:0;
}

div.tweet {
  background:url(http://a0.twimg.com/images/themes/theme1/bg.png) #C0DEED;padding:20px;
  margin:0.5em 0 0.5em 0;
} 

p.tweet{
  background:#fff;
  padding:10px 12px 10px 12px;
  margin:0;
  min-height:48px;color:#000;
  -moz-border-radius:5px;
  -webkit-border-radius:5px;
  border-radius:5px
} 

p.tweet span.metadata{
  display:block;
  width:100%;
  clear:both;
  margin-top:8px;
  padding-top:12px;
  height:40px;
  border-top:1px solid #fff;
  border-top:1px solid #e6e6e6
}

p.tweet span.metadata span.author{
  line-height:2.5ex;
} 

p.tweet span.metadata span.author img{
  float:left;
  margin:0 7px 0 0px;
  width:38px;
  height:38px
}

p.tweet a:hover{
  text-decoration:underline
}

p.tweet span.timestamp{
  font-size:9pt;
  display:block;
	margin-top:0.3em;
}

a {
    color: #278EB3;
    outline: medium none;
    text-decoration: none;
}
a:hover {
    color: #2DADDA;
}
    </style>
  </head>
  <body>
    <h1><a href="https://github.com/gimsieke/Who-Tweeted-This" target="_blank">Who Tweeted This?</a></h1>
    <div id="tweets">
    </div>

    <script>
// This is so effing ugly. Humiliating. I want to create nodes proper, but without resorting to DOM methods.
// The next Web should be done with XQuery.
var wtt_render_tweet = function(tweet, url) { 
	var created_at = tweet.created_at.replace(/\+0000/, 'UTC');
  return "<div class='tweet'><p class='tweet'>" 
            + wtt_render_tweet_text(tweet) 
            + "<span class='timestamp'>"
              + "<a title='" + created_at + "' href='http://twitter.com/#!/" + tweet.user.screen_name + "/status/" + tweet.id_str + "' target='_blank'>"
                + created_at + "</a> </span>" 
            + "<span class='timestamp'><a href='https://twitter.com/intent/favorite?tweet_id=" + tweet.id_str + "'>"
              + "<img src='http://si0.twimg.com/images/dev/cms/intents/icons/favorite.png' /> Favorite</a> "
              + "<a href='https://twitter.com/intent/retweet?tweet_id=" + tweet.id_str + "'>"
                + "<img src='http://si0.twimg.com/images/dev/cms/intents/icons/retweet.png' /> Retweet</a> "
              + "<a href='https://twitter.com/intent/tweet?in_reply_to=" + tweet.id_str + "'>"
                + "<img src='http://si0.twimg.com/images/dev/cms/intents/icons/reply.png' /> Reply</a>\n  "
              + "<a href='https://twitter.com/intent/tweet?text=" 
                          + encodeURIComponent('Thanks to “Who Tweeted This,” I found out that it was @' + wtt_genitive(tweet.user.screen_name) + ' tweet that pointed me to ' + url + ' ⇒http://chrome.google.com/webstore/detail/nlecohfddbofijkomahhaljdhbglildi')  + "'>"
                + "<img src='icons/wtt_16.png' /> Praise “Who Tweeted This”…</a></span>\n  "
            + "<span class='metadata'>"
              + "<span class='author'>"
                + "<a href='http://twitter.com/" + tweet.user.screen_name + "' target='_blank'>"
                  + "<img src='" + tweet.user.profile_image_url + "'/></a>"
                  + "<strong><a href='http://twitter.com/" + tweet.user.screen_name + "' target='_blank'>" + tweet.user.name + "</a></strong>"
                  + "<br/>" + tweet.user.screen_name + "</span></span></p></div>";
};

var wtt_render_tweet_text = function(tweet) {
  var ents = [];
  for (var etype in tweet.entities) {
    tweet.entities[etype].forEach(
      function(ent) {
        ents.push(ent);
      }
    );
  }
  var sorted_ents = ents.sort(
    function(a,b) {
      return a.indices[0] - b.indices[0];
    }
  );
  var start_pos = 0;
  var output = '';
  sorted_ents.forEach(
    function(ent) {
      end_pos = ent.indices[0];
      output += tweet.text.slice(start_pos, end_pos);
      output += wtt_tweetLink(ent);
      start_pos = ent.indices[1];
    }
  );
  var end_pos = tweet.text.length;
  output += tweet.text.slice(start_pos, end_pos);
  return sorted_ents.length == 0 ? tweet.text : output;
}

var wtt_tweetLink = function(ent) {
  if (ent.text !== undefined) {
    return "<a target='_blank' href='http://twitter.com/#!/search?q=%23" + encodeURIComponent(ent.text) + "' class='twitter-hastag' rel='nofollow' title='#" + ent.text + "'>#" + ent.text + '</a>'; 
  } else if (ent.screen_name !== undefined) {
    return "<a target='_blank' href='http://twitter.com/" + ent.screen_name + "' class='twitter-atreply' rel='nofollow' title='" + ent.name + "'>@" + ent.screen_name + '</a>'; 
  } else if (ent.url !== undefined) {
    var display_url = ent.display_url !== undefined && ent.display_url !== null ? ent.display_url : ent.url;
    var expanded_url = ent.expanded_url !== undefined && ent.expanded_url !== null ? ent.expanded_url : ent.url;
    return "<a target='_blank' href='" + ent.url + "' class='twitter-timeline-link' rel='nofollow' title='" + expanded_url + "'>" + display_url + '</a>'; 
  }
}

var wtt_genitive = function(name) {
  if (name.match(/s$/i)) {
    return name + "’";
  } else {
    return name + "’s";
  }
}

document.addEventListener(
  'DOMContentLoaded', 
  function() {
    chrome.tabs.getSelected(
      null, 
      function(tab) {
        chrome.extension.sendRequest(
          {action: "wtt_retrieve", link_href: tab.url}, 
          function(response) {
            var content = ''; // avoid DOM element creation at all cost ;-)
            for (tweet in response.tweets) {
              content += wtt_render_tweet(response.tweets[tweet], tab.url) + "\n  ";
            }
            document.getElementById('tweets').innerHTML = content;
          }
        );
      }
    );
  }, 
  false
);
    </script>

  </body>
</html>
